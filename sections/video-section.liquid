<div class="video-product-carousel bg-transparent py-14 overflow-hidden video-section">
  <div class="carousel-wrapper">
    {% for block in section.blocks %}
      <div class="video-item px-4 h-[420px] transition-all duration-300" {{ block.shopify_attributes }}>
        <!-- Video -->
        <div class="video-wrapper h-[420px] rounded-xl  transition-all duration-300">
          {% if block.settings.video_url contains 'youtube' or block.settings.video_url contains 'vimeo' %}
            <iframe
              class="w-full h-[100%] object-cover rounded-xl"
              src="{{ block.settings.video_url }}"
              frameborder="0"
              allowfullscreen
            ></iframe>
          {% else %}
            <video
              class="w-full h-[100%] object-cover rounded-xl"
              muted
              playsinline
              data-video-src="{{ block.settings.video_url }}"
            >
              <source src="{{ block.settings.video_url }}" type="video/mp4">
            </video>
          {% endif %}
        </div>
        <div
          class="product-list_{{block.id}}"
          data-product-video-section="{{ block.settings.product_list | json  | escape}}"
        ></div>
      </div>
    {% endfor %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const $carousel = $('.video-product-carousel .carousel-wrapper');

    // Initialize Slick carousel
    $carousel.slick({
      slidesToShow: 4,
      slidesToScroll: 1,
      arrows: true,
      infinite: true,
      centerMode: true,
      autoPlay: true,
      centerPadding: '60px',
      focusOnSelect: true,
      prevArrow: `<button type="button" class="bg-[#fff] w-[40px] h-[40px] rounded-[50%] flex justify-center items-center slick-prev cursor-pointer absolute left-[10px] hover:shadow-md  top-1/2 transform -translate-y-1/2 z-10">
               <svg width="30" height="30" viewBox="0 0 24 24">
                 <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" fill="none"/>
               </svg>
            </button>`,
      nextArrow: `<button type="button" class="bg-[#fff] w-[40px] h-[40px] rounded-[50%] flex justify-center items-center slick-next cursor-pointer absolute right-[10px]  hover:shadow-md top-1/2 transform -translate-y-1/2 z-10">
               <svg width="30" height="30" viewBox="0 0 24 24">
                 <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" fill="none"/>
               </svg>
            </button>`,
    });

    // Function to handle video play/pause and styling
    function handleVideoChange(slideIndex) {
      const $allVideos = $carousel.find('video');
      const $allItems = $carousel.find('.video-item');

      // Pause all videos and reset styling
      $allVideos.each(function () {
        this.pause();
        this.currentTime = 0;
      });

      // Remove active styling from all items
      $allItems.removeClass('active-video');

      // Get current active slide using slick's currentSlide
      const currentSlide = $carousel.slick('slickCurrentSlide');
      const $activeSlide = $carousel.find('.slick-slide[data-slick-index="' + currentSlide + '"]').not('.slick-cloned');
      const $activeVideo = $activeSlide.find('video');
      const $activeItem = $activeSlide.find('.video-item');

      if ($activeVideo.length > 0) {
        // Add active styling and play video
        $activeItem.addClass('active-video');
        $activeVideo[0].play().catch((e) => console.log('Video play failed:', e));
      }
    }

    // Handle slide change
    $carousel.on('afterChange', function (event, slick, currentSlide) {
      handleVideoChange(currentSlide);
    });

    // Handle click on video items
    $carousel.on('click', '.video-item', function () {
      const slideIndex = $(this).closest('.slick-slide').data('slick-index');
      if (slideIndex !== undefined) {
        $carousel.slick('slickGoTo', slideIndex);
      }
    });

    // Initialize first video after carousel is ready
    $carousel.on('init', function (event, slick) {
      setTimeout(() => {
        handleVideoChange(slick.currentSlide);
      }, 200);
    });

    // Also handle after carousel initialization is complete
    setTimeout(() => {
      if ($carousel.hasClass('slick-initialized')) {
        const currentSlide = $carousel.slick('slickCurrentSlide');
        handleVideoChange(currentSlide);
      }
    }, 300);
  });
</script>

<style>
  .product-list[data-collapsed='true'] .product-card:not(.first-product) {
    display: none;
  }

  .video-section .slick-track {
    align-items: flex-start !important;
  }

  /* Video carousel styling */
  .video-product-carousel .carousel-wrapper {
    overflow: visible !important;
  }

  .video-product-carousel .slick-list {
    overflow: visible !important;
  }

  .video-product-carousel .slick-track {
    display: flex !important;
  }

  .video-product-carousel .slick-slide {
    transition: all 0.3s ease;
    padding: 0 10px;
  }

  .video-product-carousel .slick-center {
    opacity: 1;
  }

  .video-product-carousel .slick-center .video-wrapper {
    z-index: 10;
    position: relative;
  }

  .video-product-carousel .slick-center .video-wrapper video {
    transform: scaleY(1.05);
  }

  .video-item {
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .video-wrapper {
    transition: all 0.3s ease;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .video-product-carousel .carousel-wrapper {
      .slick-list {
        overflow: visible;
      }
    }

    .video-product-carousel .slick-center .video-wrapper {
      /* transform: scale(1.2); */
      margin: 0 10px;
    }
  }

  /* Ensure videos don't autoplay by default */
  .video-product-carousel video {
    pointer-events: none;
  }

  .video-product-carousel .slick-center video {
    pointer-events: auto;
  }
</style>

{% schema %}
{
  "name": "Video Product Carousel",
  "settings": [],
  "blocks": [
    {
      "type": "item",
      "name": "Video & Product Carousel",
      "settings": [
        {
          "type": "url",
          "id": "video_url",
          "label": "Video URL (YouTube, Vimeo, or MP4)"
        },
        {
          "type": "product_list",
          "id": "product_list",
          "label": "Select products"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Video Product Carousel"
    }
  ]
}
{% endschema %}
